"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.InMemory = void 0;
const crypto_1 = __importDefault(require("crypto"));
class InMemory {
    constructor(props = null) {
        if (props) {
            this.key = InMemory.decode(props.key);
            this.iv = props.iv;
            this.notes = props.notes;
        }
        else {
            this.key = InMemory.generateKey();
            this.iv = InMemory.generateIv();
            this.notes = {};
        }
    }
    static encode(input) {
        return Buffer.from(input, InMemory.external_encoding).toString(InMemory.internal_encoding);
    }
    static decode(output) {
        return Buffer.from(output, InMemory.internal_encoding).toString(InMemory.external_encoding);
    }
    static encrypt(text, key, iv) {
        const cipher = crypto_1.default.createCipheriv(InMemory.algorithm, Buffer.from(key, InMemory.internal_encoding), Buffer.from(iv, InMemory.internal_encoding));
        const ciphertext = cipher.update(text, InMemory.external_encoding, InMemory.internal_encoding) + cipher.final(InMemory.internal_encoding);
        return ciphertext;
    }
    static decrypt(text, key, iv) {
        const decipher = crypto_1.default.createDecipheriv(InMemory.algorithm, Buffer.from(key, InMemory.internal_encoding), Buffer.from(iv, InMemory.internal_encoding));
        const plaintext = decipher.update(text, InMemory.internal_encoding, InMemory.external_encoding); // + decipher.final(InMemory.external_encoding); // works with cbc, but not gcm?
        return plaintext;
    }
    storeNote(note) {
        const material = {
            key: InMemory.generateKey(),
            iv: InMemory.generateIv()
        };
        const ciphertext = InMemory.encrypt(note, material.key, material.iv);
        this.notes[material.iv] = ciphertext;
        const link = InMemory.encode(InMemory.encrypt(JSON.stringify(material), this.key, this.iv));
        return link;
    }
    retrieveNote(link) {
        var material;
        try {
            material = JSON.parse(InMemory.decrypt(InMemory.decode(link), this.key, this.iv));
        }
        catch (e) {
            throw new Error(`Unable to decrypt link ${link}`);
        }
        if (material.iv in this.notes) {
            const ciphertext = this.notes[material.iv];
            const note = InMemory.decrypt(ciphertext, material.key, material.iv);
            delete this.notes[material.iv];
            return note;
        }
        else {
            throw new Error(`No note for link ${link}`);
        }
        ;
    }
    static generateKey(bytes = 32) {
        return InMemory.encode(this.generateRandomBytes(bytes));
    }
    static generateIv(bytes = 16) {
        return InMemory.encode(this.generateRandomBytes(bytes));
    }
    static generateRandomBytes(bytes) {
        return crypto_1.default.randomBytes(bytes);
    }
}
exports.InMemory = InMemory;
InMemory.internal_encoding = 'base64';
InMemory.external_encoding = 'utf8';
InMemory.algorithm = 'aes-256-gcm';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmFnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zdG9yYWdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLG9EQUEyQjtBQVUzQixNQUFhLFFBQVE7SUFTakIsWUFBWSxRQUE4QixJQUFJO1FBQzVDLElBQUksS0FBSyxFQUFFO1lBQ1QsSUFBSSxDQUFDLEdBQUcsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN0QyxJQUFJLENBQUMsRUFBRSxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDbkIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDO1NBQzFCO2FBQU07WUFDTCxJQUFJLENBQUMsR0FBRyxHQUFHLFFBQVEsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNsQyxJQUFJLENBQUMsRUFBRSxHQUFHLFFBQVEsQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUNoQyxJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztTQUNqQjtJQUNILENBQUM7SUFFRCxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQVU7UUFDdEIsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLGlCQUFpQixDQUFDLENBQUM7SUFDN0YsQ0FBQztJQUVELE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBVztRQUN2QixPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsaUJBQWlCLENBQUMsQ0FBQztJQUM5RixDQUFDO0lBRUQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFZLEVBQUUsR0FBVyxFQUFFLEVBQVU7UUFDbEQsTUFBTSxNQUFNLEdBQUcsZ0JBQU0sQ0FBQyxjQUFjLENBQ2xDLFFBQVEsQ0FB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Q0osQ0FBQztJQUVELE1BQU0sQ0FBQyxXQUFXLENBQUMsUUFBZ0IsRUFBRTtRQUNuQyxPQUFPLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDMUQsQ0FBQztJQUVELE1BQU0sQ0FBQyxVQUFVLENBQUMsUUFBZ0IsRUFBRTtRQUNsQyxPQUFPLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDMUQsQ0FBQztJQUVELE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxLQUFhO1FBQ3RDLE9BQU8sZ0JBQU0sQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbkMsQ0FBQzs7QUFqR0wsNEJBa0dHO0FBakdRLDBCQUFpQixHQUFpQyxRQUFRLENBQUM7QUFDM0QsMEJBQWlCLEdBQW9CLE1BQU0sQ0FBQTtBQUMzQyxrQkFBUyxHQUFHLGFBQWEsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjcnlwdG8gZnJvbSAnY3J5cHRvJ1xuXG5cbmV4cG9ydCBpbnRlcmZhY2UgSW5NZW1vcnlQcm9wcyB7XG4gICAga2V5OiBzdHJpbmc7XG4gICAgaXYgOiBzdHJpbmc7XG4gICAgbm90ZXM6IHsgW2l2OiBzdHJpbmddOiBzdHJpbmcgfTtcbiAgfVxuICBcblxuZXhwb3J0IGNsYXNzIEluTWVtb3J5IHtcbiAgICBzdGF0aWMgaW50ZXJuYWxfZW5jb2RpbmcgOiBjcnlwdG8uQmluYXJ5VG9UZXh0RW5jb2RpbmcgPSAnYmFzZTY0JztcbiAgICBzdGF0aWMgZXh0ZXJuYWxfZW5jb2RpbmcgOiBCdWZmZXJFbmNvZGluZyA9ICd1dGY4J1xuICAgIHN0YXRpYyBhbGdvcml0aG0gPSAnYWVzLTI1Ni1nY20nO1xuICBcbiAgICBrZXkhOiBzdHJpbmc7XG4gICAgaXYhOiBzdHJpbmc7XG4gICAgbm90ZXMhOiB7IFtpdjogc3RyaW5nXTogc3RyaW5nIH07XG4gICAgXG4gICAgY29uc3RydWN0b3IocHJvcHM6IEluTWVtb3J5UHJvcHMgfCBudWxsID0gbnVsbCkge1xuICAgICAgaWYgKHByb3BzKSB7XG4gICAgICAgIHRoaXMua2V5ID0gSW5NZW1vcnkuZGVjb2RlKHByb3BzLmtleSk7XG4gICAgICAgIHRoaXMuaXYgPSBwcm9wcy5pdjtcbiAgICAgICAgdGhpcy5ub3RlcyA9IHByb3BzLm5vdGVzO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5rZXkgPSBJbk1lbW9yeS5nZW5lcmF0ZUtleSgpO1xuICAgICAgICB0aGlzLml2ID0gSW5NZW1vcnkuZ2VuZXJhdGVJdigpO1xuICAgICAgICB0aGlzLm5vdGVzID0ge307XG4gICAgICB9XG4gICAgfVxuICBcbiAgICBzdGF0aWMgZW5jb2RlKGlucHV0OiBhbnkpIDogc3RyaW5nIHtcbiAgICAgIHJldHVybiBCdWZmZXIuZnJvbShpbnB1dCwgSW5NZW1vcnkuZXh0ZXJuYWxfZW5jb2RpbmcpLnRvU3RyaW5nKEluTWVtb3J5LmludGVybmFsX2VuY29kaW5nKTtcbiAgICB9XG4gIFxuICAgIHN0YXRpYyBkZWNvZGUob3V0cHV0OiBhbnkpIDogc3RyaW5nIHtcbiAgICAgIHJldHVybiBCdWZmZXIuZnJvbShvdXRwdXQsIEluTWVtb3J5LmludGVybmFsX2VuY29kaW5nKS50b1N0cmluZyhJbk1lbW9yeS5leHRlcm5hbF9lbmNvZGluZyk7XG4gICAgfVxuICBcbiAgICBzdGF0aWMgZW5jcnlwdCh0ZXh0OiBzdHJpbmcsIGtleTogc3RyaW5nLCBpdjogc3RyaW5nKSB7XG4gICAgICBjb25zdCBjaXBoZXIgPSBjcnlwdG8uY3JlYXRlQ2lwaGVyaXYoXG4gICAgICAgIEluTWVtb3J5LmFsZ29yaXRobSwgXG4gICAgICAgIEJ1ZmZlci5mcm9tKGtleSwgSW5NZW1vcnkuaW50ZXJuYWxfZW5jb2RpbmcpLCBcbiAgICAgICAgQnVmZmVyLmZyb20oaXYsIEluTWVtb3J5LmludGVybmFsX2VuY29kaW5nKVxuICAgICAgKTtcbiAgICAgIGNvbnN0IGNpcGhlcnRleHQgPSBjaXBoZXIudXBkYXRlKFxuICAgICAgICB0ZXh0LCBJbk1lbW9yeS5leHRlcm5hbF9lbmNvZGluZywgXG4gICAgICAgIEluTWVtb3J5LmludGVybmFsX2VuY29kaW5nXG4gICAgICApICsgY2lwaGVyLmZpbmFsKEluTWVtb3J5LmludGVybmFsX2VuY29kaW5nKTtcbiAgICAgIHJldHVybiBjaXBoZXJ0ZXh0O1xuICAgIH1cbiAgXG4gICAgc3RhdGljIGRlY3J5cHQodGV4dDogc3RyaW5nLCBrZXk6IHN0cmluZywgaXY6IHN0cmluZykge1xuICAgICAgY29uc3QgZGVjaXBoZXIgPSBjcnlwdG8uY3JlYXRlRGVjaXBoZXJpdihcbiAgICAgICAgSW5NZW1vcnkuYWxnb3JpdGhtLCBcbiAgICAgICAgQnVmZmVyLmZyb20oa2V5LCBJbk1lbW9yeS5pbnRlcm5hbF9lbmNvZGluZyksIFxuICAgICAgICBCdWZmZXIuZnJvbShpdiwgSW5NZW1vcnkuaW50ZXJuYWxfZW5jb2RpbmcpXG4gICAgICApO1xuICAgICAgY29uc3QgcGxhaW50ZXh0ID0gZGVjaXBoZXIudXBkYXRlKFxuICAgICAgICB0ZXh0LCBJbk1lbW9yeS5pbnRlcm5hbF9lbmNvZGluZywgXG4gICAgICAgIEluTWVtb3J5LmV4dGVybmFsX2VuY29kaW5nXG4gICAgICApIC8vICsgZGVjaXBoZXIuZmluYWwoSW5NZW1vcnkuZXh0ZXJuYWxfZW5jb2RpbmcpOyAvLyB3b3JrcyB3aXRoIGNiYywgYnV0IG5vdCBnY20/XG4gICAgICByZXR1cm4gcGxhaW50ZXh0O1xuICAgIH1cbiAgXG4gICAgc3RvcmVOb3RlKG5vdGU6IHN0cmluZykgOiBzdHJpbmcge1xuICAgICAgY29uc3QgbWF0ZXJpYWwgPSB7XG4gICAgICAgIGtleTogSW5NZW1vcnkuZ2VuZXJhdGVLZXkoKSxcbiAgICAgICAgaXY6IEluTWVtb3J5LmdlbmVyYXRlSXYoKVxuICAgICAgfTtcbiAgICAgIGNvbnN0IGNpcGhlcnRleHQgPSBJbk1lbW9yeS5lbmNyeXB0KG5vdGUsIG1hdGVyaWFsLmtleSwgbWF0ZXJpYWwuaXYpO1xuICAgICAgdGhpcy5ub3Rlc1ttYXRlcmlhbC5pdl0gPSBjaXBoZXJ0ZXh0O1xuICAgICAgY29uc3QgbGluayA9IEluTWVtb3J5LmVuY29kZShcbiAgICAgICAgSW5NZW1vcnkuZW5jcnlwdChKU09OLnN0cmluZ2lmeShtYXRlcmlhbCksIHRoaXMua2V5LCB0aGlzLml2KVxuICAgICAgKTtcbiAgICAgIHJldHVybiBsaW5rO1xuICAgIH1cbiAgXG4gICAgcmV0cmlldmVOb3RlKGxpbms6IHN0cmluZykgOiBzdHJpbmcge1xuICAgICAgdmFyIG1hdGVyaWFsO1xuICAgICAgdHJ5IHtcbiAgICAgICAgbWF0ZXJpYWwgPSBKU09OLnBhcnNlKFxuICAgICAgICAgIEluTWVtb3J5LmRlY3J5cHQoSW5NZW1vcnkuZGVjb2RlKGxpbmspLCB0aGlzLmtleSwgdGhpcy5pdilcbiAgICAgICAgKTtcbiAgICAgIH0gY2F0Y2goZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBkZWNyeXB0IGxpbmsgJHtsaW5rfWApO1xuICAgICAgfVxuICAgICAgaWYgKG1hdGVyaWFsLml2IGluIHRoaXMubm90ZXMpIHtcbiAgICAgICAgY29uc3QgY2lwaGVydGV4dCA9IHRoaXMubm90ZXNbbWF0ZXJpYWwuaXZdO1xuICAgICAgICBjb25zdCBub3RlID0gSW5NZW1vcnkuZGVjcnlwdChjaXBoZXJ0ZXh0LCBtYXRlcmlhbC5rZXksIG1hdGVyaWFsLml2KTtcbiAgICAgICAgZGVsZXRlIHRoaXMubm90ZXNbbWF0ZXJpYWwuaXZdO1xuICAgICAgICByZXR1cm4gbm90ZVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBub3RlIGZvciBsaW5rICR7bGlua31gKTtcbiAgICAgIH07XG4gICAgfVxuICBcbiAgICBzdGF0aWMgZ2VuZXJhdGVLZXkoYnl0ZXM6IG51bWJlciA9IDMyKTogc3RyaW5nIHtcbiAgICAgIHJldHVybiBJbk1lbW9yeS5lbmNvZGUodGhpcy5nZW5lcmF0ZVJhbmRvbUJ5dGVzKGJ5dGVzKSk7XG4gICAgfVxuICBcbiAgICBzdGF0aWMgZ2VuZXJhdGVJdihieXRlczogbnVtYmVyID0gMTYpIDogc3RyaW5nIHtcbiAgICAgIHJldHVybiBJbk1lbW9yeS5lbmNvZGUodGhpcy5nZW5lcmF0ZVJhbmRvbUJ5dGVzKGJ5dGVzKSk7XG4gICAgfVxuICBcbiAgICBzdGF0aWMgZ2VuZXJhdGVSYW5kb21CeXRlcyhieXRlczogbnVtYmVyKSA6IEJ1ZmZlciB7XG4gICAgICByZXR1cm4gY3J5cHRvLnJhbmRvbUJ5dGVzKGJ5dGVzKTtcbiAgICB9XG4gIH0iXX0=